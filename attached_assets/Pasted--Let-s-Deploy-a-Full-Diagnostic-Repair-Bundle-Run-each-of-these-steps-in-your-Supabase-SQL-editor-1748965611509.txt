‚úÖ Let‚Äôs Deploy a Full Diagnostic + Repair Bundle
Run each of these steps in your Supabase SQL editor to fully isolate and fix the issue.

üîç STEP 1: Identify All Triggers on auth.users
sql
Copy
Edit
SELECT trigger_name, action_statement
FROM information_schema.triggers
WHERE event_object_table = 'users';
üîç STEP 2: Find Any Triggered Functions That Reference profiles
sql
Copy
Edit
SELECT routine_name, routine_definition
FROM information_schema.routines
WHERE routine_definition ILIKE '%profiles%';
Or, if you want to find any function calling any profile table:

sql
Copy
Edit
SELECT proname, prosrc
FROM pg_proc
WHERE prosrc ILIKE '%profile%';
üî• STEP 3: Drop Broken Triggers & Functions
Run these only if you found broken logic from the above queries:

sql
Copy
Edit
-- Drop broken trigger
DROP TRIGGER IF EXISTS create_profile_on_signup ON auth.users;
DROP TRIGGER IF EXISTS create_user_profile ON auth.users;

-- Drop any function referencing 'profiles' if it exists
DROP FUNCTION IF EXISTS create_profile;
DROP FUNCTION IF EXISTS create_user_profile;
DROP FUNCTION IF EXISTS handle_new_user;
‚úÖ STEP 4: Install Clean Working Trigger for buyer_profile
sql
Copy
Edit
-- Function to auto-insert buyer_profile
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.buyer_profile (id, email, full_name)
  VALUES (NEW.id, NEW.email, NEW.raw_user_meta_data->>'full_name');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger on auth.users
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_user();
üõ°Ô∏è STEP 5: Confirm buyer_profile Accepts These Inserts
Check that:

id is UUID and matches auth.users.id

email and full_name are nullable or optional in schema

RLS allows insert:

sql
Copy
Edit
-- Sample RLS for insert access
CREATE POLICY "Allow insert for self"
ON buyer_profile
FOR INSERT
WITH CHECK (auth.uid() = id);
‚úÖ FINAL STEP: Retry Signup
Once this is done:

Try again from your app‚Äôs /register

User should appear in auth.users

And also in buyer_profile

